---
title: "nvim + coc.nvimã§C23ã®ç’°å¢ƒã‚’æ•´ãˆã‚‹"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cpp", "c", "clangd", "nvim", "mac"]
published: true
---

## ç’°å¢ƒ

CPU : Apple M1 Max
ãƒ¡ãƒ¢ãƒª : 64GB
OS : macOS 13.2.1

## ç¾çŠ¶ç¢ºèª

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ(ï¼Ÿ)ã§ã¯`Apple clang`ã¨ã„ã†ç‹¬è‡ªã®ã‚‚ã®ãŒå…¥ã£ã¦ã„ã¦ã“ã‚Œã¯ c++23 ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒä½¿ãˆãªã„

```bash
$ g++ -v
Apple clang version 14.0.0 (clang-1400.0.29.202)
Target: arm64-apple-darwin22.3.0
Thread model: posix
InstalledDir: /Library/Developer/CommandLineTools/usr/bin
```

```bash
$ g++ -o main -std=c++23 main.cpp
error: invalid value 'c++23' in '-std=c++23'
note: use 'c++98' or 'c++03' for 'ISO C++ 1998 with amendments' standard
note: use 'gnu++98' or 'gnu++03' for 'ISO C++ 1998 with amendments and GNU extensions' standard
note: use 'c++11' for 'ISO C++ 2011 with amendments' standard
note: use 'gnu++11' for 'ISO C++ 2011 with amendments and GNU extensions' standard
note: use 'c++14' for 'ISO C++ 2014 with amendments' standard
note: use 'gnu++14' for 'ISO C++ 2014 with amendments and GNU extensions' standard
note: use 'c++17' for 'ISO C++ 2017 with amendments' standard
note: use 'gnu++17' for 'ISO C++ 2017 with amendments and GNU extensions' standard
note: use 'c++20' for 'ISO C++ 2020 DIS' standard
note: use 'gnu++20' for 'ISO C++ 2020 DIS with GNU extensions' standard
note: use 'c++2b' for 'Working draft for ISO C++ 2023 DIS' standard
note: use 'gnu++2b' for 'Working draft for ISO C++ 2023 DIS with GNU extensions' standard
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹PATHã‹ã‚‰ã—ã¦homebrewã§å…¥ã‚ŒãŸã‚‚ã®ã§ã¯ç„¡ã•ãã†ãªã®ã§å‡ºæ¥ã‚‹ã ã‘å‰Šé™¤ã¯ã—ãŸããªã„[^1]

```bash
$ whereis g++
g++: /usr/bin/g++
```

c++ã® Language Server ã§ã‚ã‚‹ clangd ã‚‚åŒæ§˜

```bash
$ clangd --version
Apple clangd version 14.0.0 (clang-1400.0.29.202)
Features: mac+xpc
Platform: x86_64-apple-darwin22.3.0; target=arm64-apple-darwin22.3.0
```

ã“ã®çŠ¶æ…‹ã‚’æ”¹å–„ã—ã¦ c++23 ã®ãƒ“ãƒ«ãƒ‰ãŒå‡ºæ¥ã€Language server ã®æ©æµã‚’å—ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ãªçŠ¶æ…‹ã‚’ç›®æŒ‡ã™

```bash
$ whereis clangd
clangd: /usr/bin/clangd
```

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

c++23ã®å‹•ä½œç¢ºèªç”¨ã‚³ãƒ¼ãƒ‰

```cpp
#include <expected>
#include <iomanip>
#include <iostream>
#include <string>

// æ•´æ•°é™¤ç®—
std::expected<int, std::string> idiv(int a, int b)
{
  if (b == 0) {
    return std::unexpected{"divide by zero"};
  }
  if (a % b != 0) {
    return std::unexpected{"out of domain"};        
  }
  return a / b;
}

void dump_result(const std::expected<int, std::string>& v)
{
  if (v) {
    std::cout << *v << std::endl;
  } else {
    std::cout << std::quoted(v.error()) << std::endl;        
  }
}

int main()
{
  dump_result(idiv(10, 2));
  dump_result(idiv(10, 3));
  dump_result(idiv(10, 0));
}
```

[^2]

## ç’°å¢ƒæ§‹ç¯‰

### ãƒ“ãƒ«ãƒ‰

homebrewã‚’ä½¿ã£ã¦gccã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
brew install gcc
```

`/opt/homebrew/bin` ä¸‹ã«`g++-13`ã¨ã„ã†åå‰ã§g++ãŒå…¥ã‚‹

```bash
$ whereis g++-13
g++-13: /opt/homebrew/bin/g++-13
```

version ç¢ºèª

```bash
$ g++-13 --version
g++-13 (Homebrew GCC 13.2.0) 13.2.0
Copyright (C) 2023 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```

ã“ã®æ™‚ç‚¹ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒ“ãƒ«ãƒ‰ã¯å‡ºæ¥ã‚‹

```bash
g++-13 -o main -std=c++23 main.cpp
```

é¢å€’ãªã®ã§Makefileã«ã¾ã¨ã‚ã‚‹

```makefile:Makefile
.DEFAULT_GOAL := help

build: ## build binary
    g++-13 -std=c++23 -o main main.cpp

help: ## Show options
    @grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
            awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'
```

ã“ã‚Œã«ã‚ˆã‚Š

```bash
make build
```

ã§ãƒ“ãƒ«ãƒ‰å‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚‹

### Language Server

language serverã®ãƒ›ã‚¹ãƒˆã¨ã—ã¦`coc-nvim`ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã“ã¡ã‚‰ã‹ã‚‰`clangd`ã‚’å‘¼ã³å‡ºã—ãŸã„
æœ€ã‚‚ã¦ã£ã¨ã‚Šæ—©ã„æ–¹æ³•ã¨ã—ã¦ã¯coc-clangdã¨ã„ã†æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

```coc
CocInstall coc-clangd
```

ã—ã‹ã—ã€ã“ã‚Œã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨æ—¢ã«PATHãŒé€šã£ã¦ã„ã‚‹å¤ã„`clangd`ã‚’å‘¼ã³ã ã—ã¦ã—ã¾ã†ãŸã‚ã€c++23ã®æ©Ÿèƒ½ã¯ä½¿ãˆãªã„ã€‚
ã¾ãšã¯æ–°ã—ã„`clangd`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ãŠãã‚‰ãæœ€ã‚‚ã¦ã£ã¨ã‚Šæ—©ã„æ–¹æ³•ã¯homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‡ºæ¥ã‚‹`llvm`ã«ä»˜å±ã—ã¦ã„ã‚‹`g++`ã‚’ä½¿ã†æ–¹æ³•ã€‚

```bash
brew install llvm
```

ã“ã‚Œã«ã‚ˆã‚Š`/opt/homebrew/opt/llvm/bin/` ä¸‹ã«`clangd`ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã€‚
`coc-settings.json`ã«ä¸‹è¨˜ã‚’è¿½åŠ ã—ã¦`llvm`ã«ä»˜å±ã—ãŸ`clangd`ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã€‚

```json:coc-settings.json
{
  "clangd.path": "/opt/homebrew/opt/llvm/bin/clangd"
}
```

c++ã®ã‚³ãƒ¼ãƒ‰ãŒç½®ã‹ã‚Œã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç›´ä¸‹ã«`compile_flags.txt`ã‚’ç½®ã„ã¦å®Œæˆ

```bash:compile_flags.txt
-std=c++23
```

cppã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ãŸæ™‚ç‚¹ã§è£œå®Œç­‰ã®Language Serverã®æ©Ÿèƒ½ãŒåƒã„ã¦ã„ã‚Œã°OK

## Tips

ä»Šå›ã¯æ¡ç”¨ã—ãªã‹ã£ãŸãŒPATH ã¯å…ˆã«èª­ã¿è¾¼ã‚“ã ã‚‚ã®ã‹ã‚‰é †ã«æ¤œç´¢ã‚’è¡Œã„ã€æŒ‡å®šã—ãŸãƒã‚¤ãƒŠãƒªãŒè¦‹ã¤ã‹ã£ãŸæ™‚ç‚¹ã§ãã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã®ã§`.bashrc`ãªã©ã§ PATH ã‚’è¨­å®šã™ã‚‹éš›ã«

```bash
export PATH=/opt/homebrew/bin:/opt/homebrew/opt/llvm/bin:$PATH:
```

ã®ã‚ˆã†ã«ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® PATH ã‚ˆã‚Šå‰ã« homebrew ã‚„ llvm ã® bin ã‚’æŒ‡å®šã—ã¦ãŠã‘ã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® g++ã‚„ clangd ã‚‚æ®‹ã—ãŸã¾ã¾ homebrew ã§å…¥ã‚ŒãŸãƒã‚¤ãƒŠãƒªã‚’å„ªå…ˆçš„ã«åˆ©ç”¨å‡ºæ¥ã‚‹ã€‚
æ—¢å­˜ã®ãƒã‚¤ãƒŠãƒªã‚’æ¶ˆã—ãŸãã¯ãªã„ãŒå„ªå…ˆçš„ã«æ–°ã—ã„ãƒã‚¤ãƒŠãƒªã‚’åˆ©ç”¨ã—ãŸã„å ´åˆãªã©ã«åˆ©ç”¨ã§ãã‚‹ã€‚

[^1]: ã‚‚ã—ã‹ã—ãŸã‚‰xcodeå‘¨ã‚Šã®ç’°å¢ƒã‚’æ•´ãˆãŸæ™‚ã«ã¤ã„ã§ã«å…¥ã£ã¦ããŸã‚‚ã®ã‹ã‚‚ã€‚ãã‚Œã§ã‚ã‚Œã°å‰Šé™¤ã—ã¦ã‚‚å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚‚ç°¡å˜ãã†ãªã®ã§å¤§ä¸ˆå¤«ã‹ã‚‚ã€‚è¦ç¢ºèªã€‚
[^2]: [å‚è€ƒ](https://cpprefjp.github.io/reference/expected/expected.html)
